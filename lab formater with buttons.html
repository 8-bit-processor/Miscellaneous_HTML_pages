<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Report Organizer</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff;
            color: #000;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-size: 1rem;
        }
        button {
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 10px;
            background-color: #007bff; /* Primary button color */
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: block;
            width: 100%;
            margin-top: 1.5rem;
            font-size: 1.05rem;
        }
        button:hover {
            background-color: #0056b3;
        }
        /* Style for the 'Clear Text' button */
        button[onclick*="clearSource"] {
            background-color: #6c757d; /* Secondary color */
        }
        button[onclick*="clearSource"]:hover {
            background-color: #5a6268;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .abnormal {
            font-weight: bold;
            color: #d9534f; /* A subtle red for attention */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">Lab Report Organizer</h1>
        <div class="card">
            <h4>Source Document</h4>
            <textarea id="inputText" placeholder="Paste your lab report here..." oninput="processLabReport(); generateOutput();"></textarea>
            
            <button onclick="processLabReport(); generateOutput();" style="margin-top: 1rem;">Process Lab Report</button>
            <button onclick="clearSource()" style="background-color: #6c757d; margin-top: 1rem;">Clear Text</button>
        </div>
        <div class="card">
            <h4>Organized Lab Data</h4>
            <div id="testSelection" style="margin-bottom: 1rem;"></div>
            
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
            <div id="output">
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let parsedData = [];
            let allTestNames = [];

            const testGroups = {
                'CBC': ['WBC', 'RBC', 'HGB', 'HCT', 'MCV', 'MCHC', 'RDW', 'PLT', 'MPV', 'NEUT %', 'LYMPH %', 'MONO %', 'EOSIN %', 'IMMATURE GRAN %', 'ABSOLUTE NEUTROPHIL COUNT', 'ABSOLUTE LYMPHOCYTE COUNT', 'NRBC/100WBC'],
                'CK': ['CT-TOTAL', 'CK-MM', 'CK-MB', 'CK-BB'],
                'CHEM': ['SODIUM', 'POTASSIUM', 'CHLORIDE', 'CO2', 'UREA NITROGEN, BLOOD', 'CREATININE,SERUM', 'eGFR', 'GLUCOSE,RANDOM', 'ANION GAP'],
                'LIVER': ['ALBUMIN', 'TOT. BILIRUBIN', 'DIR. BILIRUBIN', 'AST', 'ALT', 'ALKALINE PHOSPHATASE', 'PT/IRN'],
                'CHOLESTEROL': ['CHOLESTEROL', 'TRIGLYCERIDE', 'LDL', 'HDL'],
                'INFLAMMATION': ['CRP, INFRAMMATION', 'ESR'],
                'HEMOGLOBIN A1c': ['HEMOGLOBIN A1c'],
                'VITAMIN D TOTAL(SCREEN)': ['VITAMIN D TOTAL(SCREEN)'],
                'URINALYSIS': ['URINE COLOR.APPEARANCE', 'SPECIFIC GRAVITY', 'URINE pH', 'URINE BLOOD', 'LEUCOCYTE ESTERASE', 'NITRITE,URINE', 'URINE PROTEIN', 'URINE GLUCOSE', 'URINE KETONES', 'URINE BIRIRUBIN', 'UROBILINOGEN'],
                'TSH': ['TSH'],
                'B12': ['B12'],
                'PROSTATE': ['PSA']
            };
            const groupOrder = ['CBC', 'CK', 'CHEM', 'LIVER', 'CHOLESTEROL', 'INFLAMMATION', 'HEMOGLOBIN A1c', 'VITAMIN D TOTAL(SCREEN)', 'URINALYSIS', 'TSH', 'B12', 'PROSTATE', 'Other'];

            function isAbnormal(result, range) {
                if (typeof result !== 'string' || typeof range !== 'string' || result.trim() === '' || range.trim() === '') {
                    return false;
                }
                const numericResult = parseFloat(result.replace(/[<>]/g, ''));
                if (isNaN(numericResult)) {
                    return false;
                }
                const rangeMatch = range.match(/(\d*\.?\d+)\s*-\s*(\d*\.?\d+)/);
                if (rangeMatch) {
                    const low = parseFloat(rangeMatch[1]);
                    const high = parseFloat(rangeMatch[2]);
                    return numericResult < low || numericResult > high;
                }
                return false;
            }

            window.copyToClipboard = function() {
                const outputDiv = document.getElementById('output');
                const tables = outputDiv.querySelectorAll('table');
                if (tables.length === 0) {
                    alert('Nothing to copy!');
                    return;
                }
                let textToCopy = '';
                tables.forEach(table => {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        let rowText = [];
                        cells.forEach(cell => {
                            rowText.push(cell.innerText.replace(/\n/g, ' '));
                        });
                        textToCopy += rowText.join('\t') + '\n';
                    });
                    textToCopy += '\n';
                });
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('Copied to clipboard!');
                }, () => {
                    alert('Failed to copy!');
                });
            }

            window.clearSource = function() {
                document.getElementById('inputText').value = '';
                document.getElementById('testSelection').innerHTML = '';
                document.getElementById('output').innerHTML = '';
            }

            window.processLabReport = function() {
                const inputText = document.getElementById('inputText').value;
                const reports = inputText.split(/===============================================================================/g);
                parsedData = [];
                allTestNames = [];
                for (const group in testGroups) {
                    allTestNames.push(...testGroups[group]);
                }
                allTestNames = [...new Set(allTestNames)].sort();

                for (const report of reports) {
                    if (report.trim().length === 0) continue;
                    const lines = report.trim().split('\n');
                    let collectionDate = null;
                    let specimen = null;

                    for (const line of lines) {
                        const dateMatch = line.match(/Specimen Collection Date:\s*([A-Za-z]{3}\s+\d{1,2},\s+\d{4}@\d{1,2}:\d{2})/);
                        if (dateMatch) {
                            const parsedDate = new Date(dateMatch[1]);
                            if (!isNaN(parsedDate.getTime())) {
                                collectionDate = parsedDate;
                            }
                        }
                        const specimenMatch = line.match(/Specimen(?: Type)?:\s*([^.]+)/i);
                        if (specimenMatch) {
                            specimen = specimenMatch[1].trim();
                        }
                    }

                    if (!collectionDate || !specimen) continue;

                    let inTestSection = false;
                    for (const line of lines) {
                        if (line.trim().startsWith('Test name')) {
                            inTestSection = true;
                            continue;
                        }
                        if (!inTestSection || line.trim().length === 0 || line.startsWith('=')) continue;

                        for (const knownTestName of allTestNames) {
                            if (line.trim().startsWith(knownTestName)) {
                                const remainingLine = line.trim().substring(knownTestName.length).trim();
                                const partsMatch = remainingLine.match(/^\s*([^\s]+(?:\s+[^\s]+)*?)\s*([^\s]+(?:\s+[^\s]+)*?)?\s*(.*)$/);
                                if (partsMatch) {
                                    const result = (partsMatch[1] || '').trim();
                                    const units = (partsMatch[2] || '').trim();
                                    let range = (partsMatch[3] || '').trim();
                                    if (range.startsWith('Ref:')) {
                                        range = range.substring(4).trim();
                                    }
                                    range = range.replace(/\s*\[\d+\]/g, '').trim();
                                    range = range.replace(/\s+/g, ' ').trim();
                                    parsedData.push({
                                        collectionTime: collectionDate,
                                        specimen: specimen,
                                        testName: knownTestName,
                                        result: result,
                                        units: units,
                                        range: range
                                    });
                                    break; 
                                }
                            }
                        }
                    }
                }

                if (parsedData.length === 0) {
                    alert("No valid lab data found. Please check the input format.");
                    return;
                }
                allTestNames = [...new Set(parsedData.map(item => item.testName))].sort();
                displayGroupSelection();
            }

            window.displayGroupSelection = function() {
                const testSelectionDiv = document.getElementById('testSelection');
                testSelectionDiv.innerHTML = '<h4>Select Test Groups to Display:</h4>';
                const allGroupedTests = [].concat.apply([], Object.values(testGroups));
                const otherTests = allTestNames.filter(testName => !allGroupedTests.includes(testName));
                const displayGroups = { ...testGroups };
                if (otherTests.length > 0) {
                    displayGroups['Other'] = otherTests;
                }

                for (const groupName of groupOrder) {
                    if (!displayGroups[groupName]) continue;
                    const groupContainer = document.createElement('div');
                    groupContainer.style.marginBottom = '10px';
                    const mainCheckbox = document.createElement('input');
                    mainCheckbox.type = 'checkbox';
                    mainCheckbox.id = groupName;
                    mainCheckbox.value = groupName;
                    mainCheckbox.checked = true;
                    mainCheckbox.onchange = generateOutput;
                    const label = document.createElement('label');
                    label.htmlFor = groupName;
                    label.style.fontWeight = 'bold';
                    label.appendChild(document.createTextNode(groupName));
                    groupContainer.appendChild(mainCheckbox);
                    groupContainer.appendChild(label);

                    if (groupName === 'Other' && otherTests.length > 0) {
                        const sublist = document.createElement('div');
                        sublist.style.marginLeft = '20px';
                        mainCheckbox.addEventListener('change', (e) => {
                            sublist.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                cb.checked = e.target.checked;
                            });
                        });
                        for (const testName of otherTests) {
                            const testCheckbox = document.createElement('input');
                            testCheckbox.type = 'checkbox';
                            testCheckbox.id = `test-${testName}`;
                            testCheckbox.value = testName;
                            testCheckbox.checked = true;
                            testCheckbox.onchange = generateOutput;
                            testCheckbox.className = 'other-test-checkbox';
                            const testLabel = document.createElement('label');
                            testLabel.htmlFor = `test-${testName}`;
                            testLabel.appendChild(document.createTextNode(testName));
                            const testContainer = document.createElement('div');
                            testContainer.appendChild(testCheckbox);
                            testContainer.appendChild(testLabel);
                            sublist.appendChild(testContainer);
                        }
                        groupContainer.appendChild(sublist);
                    } else {
                        mainCheckbox.dataset.tests = JSON.stringify(displayGroups[groupName]);
                    }
                    testSelectionDiv.appendChild(groupContainer);
                }
            }

            window.generateOutput = function() {
                const selectedTests = new Set();
                document.querySelectorAll('#testSelection input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.id === 'Other') {
                        document.querySelectorAll('.other-test-checkbox:checked').forEach(otherCb => {
                            selectedTests.add(otherCb.value);
                        });
                    } else if (checkbox.dataset.tests) {
                        JSON.parse(checkbox.dataset.tests).forEach(test => selectedTests.add(test));
                    }
                });

                const filteredData = parsedData.filter(item => selectedTests.has(item.testName));
                const groupedBySpecimen = {};
                for (const item of filteredData) {
                    if (!groupedBySpecimen[item.specimen]) {
                        groupedBySpecimen[item.specimen] = [];
                    }
                    groupedBySpecimen[item.specimen].push(item);
                }

                const outputDiv = document.getElementById('output');
                outputDiv.innerHTML = '';

                for (const specimen in groupedBySpecimen) {
                    const specimenData = groupedBySpecimen[specimen];
                    const uniqueDates = [...new Set(specimenData.map(item => item.collectionTime.getTime()))]
                        .map(time => new Date(time))
                        .sort((a, b) => b - a);
                    const testInfo = {};
                    const resultsByDate = {};
                    const allSpecimenTests = [...new Set(specimenData.map(item => item.testName))];

                    for (const testName of allSpecimenTests) {
                        const firstData = specimenData.find(d => d.testName === testName);
                        testInfo[testName] = { range: firstData ? firstData.range : 'N/A' };
                    }

                    for (const item of specimenData) {
                        const dateKey = item.collectionTime.getTime();
                        if (!resultsByDate[dateKey]) {
                            resultsByDate[dateKey] = {};
                        }
                        resultsByDate[dateKey][item.testName] = item.result;
                    }

                    const specimenTitle = document.createElement('h5');
                    specimenTitle.textContent = `--- ${specimen} ---`;
                    outputDiv.appendChild(specimenTitle);

                    for (const groupName of groupOrder) {
                        let testsInGroupForSpecimen;
                        if (groupName === 'Other') {
                            const allGroupedTests = [].concat.apply([], Object.values(testGroups));
                            testsInGroupForSpecimen = allSpecimenTests.filter(test => !allGroupedTests.includes(test) && selectedTests.has(test));
                        } else {
                            testsInGroupForSpecimen = (testGroups[groupName] || []).filter(test => allSpecimenTests.includes(test) && selectedTests.has(test));
                        }

                        if (testsInGroupForSpecimen.length === 0) continue;

                        const groupTitle = document.createElement('h6');
                        groupTitle.textContent = `-- ${groupName} --`;
                        groupTitle.style.marginTop = '1rem';
                        outputDiv.appendChild(groupTitle);

                        const table = document.createElement('table');
                        table.id = 'outputTable';
                        const thead = table.createTHead();
                        const tbody = table.createTBody();
                        
                        const headerRow = thead.insertRow();
                        const headerCell = document.createElement('th');
                        headerCell.textContent = 'Collection Date';
                        headerRow.appendChild(headerCell);

                        for (const testName of testsInGroupForSpecimen) {
                            const th = document.createElement('th');
                            th.innerHTML = `${testName}<br><small>${testInfo[testName].range || ''}</small>`;
                            headerRow.appendChild(th);
                        }

                        for (const date of uniqueDates) {
                            const row = tbody.insertRow();
                            const dateCell = row.insertCell();
                            dateCell.textContent = date.toLocaleDateString();
                            const dateKey = date.getTime();

                            for (const testName of testsInGroupForSpecimen) {
                                const cell = row.insertCell();
                                const result = resultsByDate[dateKey]?.[testName] || '';
                                const range = testInfo[testName]?.range || '';
                                cell.textContent = result;
                                if (isAbnormal(result, range)) {
                                    cell.classList.add('abnormal');
                                    cell.textContent = result + ' *';
                                }
                            }
                        }
                        const tableContainer = document.createElement('div');
                        tableContainer.style.overflowX = 'auto';
                        tableContainer.appendChild(table);
                        outputDiv.appendChild(tableContainer);
                    }
                }
            }
        });
    </script>
</body>
</html>