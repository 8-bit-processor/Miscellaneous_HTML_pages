<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Report Formatter</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h4 {
            text-align: center;
            color: #343a40;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
            font-size: 1rem;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            margin: 10px 5px;
            display: inline-block;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .abnormal {
            font-weight: bold;
            color: #d9534f; /* A subtle red for attention */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lab Report Formatter</h1>
        
        <h4>Source Document</h4>
        <textarea id="inputText" placeholder="Paste your lab report here..."></textarea>
        <button onclick="processAndGenerate()">Format Report</button>
        <button onclick="clearSource()">Clear Text</button>
        
        <h4>Formatted Output</h4>
        <button onclick="copyToClipboard()">Copy Table</button>
        <div id="output"></div>
    </div>

    <script>
        let parsedData = [];

        function processAndGenerate() {
            processLabReport();
            generateOutput();
        }

        function clearSource() {
            document.getElementById('inputText').value = '';
            document.getElementById('output').innerHTML = '';
        }

        function copyToClipboard() {
            const outputDiv = document.getElementById('output');
            const table = outputDiv.querySelector('table');
            if (!table) {
                alert('Nothing to copy!');
                return;
            }

            let textToCopy = '';
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                let rowText = [];
                cells.forEach(cell => {
                    rowText.push(cell.innerText);
                });
                textToCopy += rowText.join('\t') + '\n';
            });

            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Formatted table copied to clipboard!');
            }, () => {
                alert('Failed to copy.');
            });
        }

        function isAbnormal(result, range) {
            if (typeof result !== 'string' || typeof range !== 'string' || result.trim() === '' || range.trim() === '') {
                return false;
            }

            const numericResult = parseFloat(result);
            if (isNaN(numericResult)) {
                return false; // Cannot compare non-numeric results
            }

            // Simple range format "low-high"
            const rangeMatch = range.match(/(\d*\.?\d+)\s*-\s*(\d*\.?\d+)/);
            if (rangeMatch) {
                const low = parseFloat(rangeMatch[1]);
                const high = parseFloat(rangeMatch[2]);
                return numericResult < low || numericResult > high;
            }
            
            // Other formats like "< 50" or "> 100" can be added here if needed
            
            return false;
        }

        function processLabReport() {
            const inputText = document.getElementById('inputText').value;
            // Basic parsing logic, assuming a simple structure.
            // This will need to be robust based on the actual format.
            const lines = inputText.trim().split('\n');
            parsedData = [];
            
            lines.forEach(line => {
                // A simple regex to capture "Test Name: Result Units (Range)"
                // This needs to be adapted to the specific format of the lab report.
                const parts = line.match(/^[\w\s\/\(\),-]+:\s*([\d\.\*\s]+)\s*([\w\/\sL]+)?\s*\(([^\)]+)\)/);
                if (parts) {
                    parsedData.push({
                        testName: parts[1].trim(),
                        result: parts[2].trim(),
                        units: parts[3] ? parts[3].trim() : '',
                        range: parts[4].trim()
                    });
                }
            });
             if (parsedData.length === 0) {
                alert("No valid lab data found. Please check the input format. This tool expects lines like 'Test Name: Result Units (Range)'.");
            }
        }

        function generateOutput() {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '';

            if (parsedData.length === 0) {
                return;
            }

            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();

            const headerRow = thead.insertRow();
            const headers = ['Test Name', 'Result', 'Units', 'Reference Range'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            parsedData.forEach(item => {
                const row = tbody.insertRow();
                
                const testNameCell = row.insertCell();
                testNameCell.textContent = item.testName;

                const resultCell = row.insertCell();
                const abnormal = isAbnormal(item.result, item.range);
                resultCell.textContent = item.result;
                if (abnormal) {
                    resultCell.innerHTML = `<span class="abnormal">${item.result} *</span>`;
                }


                const unitsCell = row.insertCell();
                unitsCell.textContent = item.units;

                const rangeCell = row.insertCell();
                rangeCell.textContent = item.range;
            });

            outputDiv.appendChild(table);
        }
    </script>
</body>
</html>